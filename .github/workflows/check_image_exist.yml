name: Check if Docker image exists

on:
  schedule:
    - cron: '0 0 * * 0'  # 每周天检查一次上游仓库（可自定义）
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Check image exist
      run: |
        # 获取上游仓库的最新 tags
        upstream_tags=$(curl -s -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/nicoboss/nsz/tags)

        # 提取最新的 tag 名称
        latest_tag_name=$(echo "$upstream_tags" | jq -r '.[0].name // empty')
        echo "Latest upstream tag: $latest_tag_name"

        # 如果没有获取到 tag，则退出
        [ -z "$latest_tag_name" ] && exit 1

        # 定义镜像名称和要检查的 tag
        image_name="zhengyongtao/nsz"
        tag_to_check="$latest_tag_name"

        # 构造 Docker Hub API URL
        api_url="https://registry.hub.docker.com/v2/repositories/${image_name}/tags/${tag_to_check}"

        # 使用 curl 查询镜像 tag 的详细信息
        http_status=$(curl -s -o /dev/null -w "%{http_code}\n" "${api_url}")

        if [[ "$http_status" == "404" ]]; then
            echo "The tag ${tag_to_check} does not exist for the image ${image_name}."
        else
            echo "The tag ${tag_to_check} exists for the image ${image_name}." 
            skip_flag=true
        fi
        # 将 tag 名称存储为环境变量
        echo "UPSTREAM_TAG=$latest_tag_name" >> $GITHUB_ENV
      id: check_image_exist

    - name: Checkout code at upstream tag
      if: ${{ ! steps.check_image_exist.outputs.skip_flag }}
      uses: ./.github/workflows/build_image.yml
      env:
        UPSTREAM_TAG: ${{ env.UPSTREAM_TAG }}

